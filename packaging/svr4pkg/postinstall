#! /bin/sh

# Postinstall script for COSas package
# $Id: postinstall,v 1.19 2016/09/18 08:13:31 jim Exp $

PATH="/usr/bin:/usr/sbin:${PATH}"
export PATH

if [ x"${BASEDIR}" != x -a x"${BASEDIR}" != x/ -a -d "${BASEDIR}" -a -d "${BASEDIR}/etc" ]; then
	ORACLE_SCHEMA_LIST_OLD="$BASEDIR/oracle_schemas.txt"
	ORACLE_SCHEMA_LIST="$BASEDIR/etc/oracle_schemas.txt"
	MYSQL_SCHEMA_LIST="$BASEDIR/etc/mysql_schemas.txt"
	PGSQL_SCHEMA_LIST="$BASEDIR/etc/pgsql_schemas.txt"

	AMLOGIN_CHECK_CFG="$BASEDIR/etc/check-amserver-login.sh.conf"
	MAGNOLIA_CHECK_CFG="$BASEDIR/etc/check-magnolia.sh.conf"

	DUMPER_GENERIC="$BASEDIR/etc/dumper-generic.sh.conf"

	DUMPER_LDAP_ADS="$BASEDIR/etc/dumper-sundsee6-ads.sh.conf"
	DUMPER_LDAP_ADS_LDIF="$BASEDIR/etc/dumper-sundsee6-ads-ldif.sh.conf"

	if [ -s "$ORACLE_SCHEMA_LIST_OLD" -a ! -s "$ORACLE_SCHEMA_LIST" ]; then
		echo "= Migrate old Oracle schema list file to new location..."
		mv -f "$ORACLE_SCHEMA_LIST_OLD" "$ORACLE_SCHEMA_LIST"
	fi

	if [ ! -f "$ORACLE_SCHEMA_LIST" ]; then
		echo "= Generate an Oracle schema list file template"
		echo "# Oracle schemas to dump. One entry per line, format:
# user:pass:sid
# Empty PASS or SID are set per default by dumper-oracle-export-multiple.sh
# To list your schemas and users in SQLPlus use oracle UNIX account:
# [oracle@db ~]$ sqlplus / as sysdba
# SQL> set linesize 124
# SQL> select distinct OWNER from ALL_OBJECTS;
# SQL> select USERNAME,ACCOUNT_STATUS,LOCK_DATE,EXPIRY_DATE from DBA_USERS where ACCOUNT_STATUS='OPEN' order by USERNAME;
" > "$ORACLE_SCHEMA_LIST" && chmod 600 "$ORACLE_SCHEMA_LIST" && chown 0:0 "$ORACLE_SCHEMA_LIST"
	fi

	if [ ! -f "$MYSQL_SCHEMA_LIST" ]; then
		echo "= Generate a MySQL schema list file template"
		echo "# MySQL schemas to dump. One entry per line, format:
# user:pass:dbname
# Empty USER or PASS are set per default by dumper-mysql-export-multiple.sh
# DBNAME is required
# Use of standard ~/.my.cnf file is suggested to pass user/password quietly
# To list current databases use:
#   mysql -e 'show databases;' | awk '{print $1}' | fgrep -v Database
::mysql" > "$MYSQL_SCHEMA_LIST" && chmod 600 "$MYSQL_SCHEMA_LIST" && chown 0:0 "$MYSQL_SCHEMA_LIST"
	fi

	if [ ! -f "$PGSQL_SCHEMA_LIST" ]; then
		echo "= Generate a PgSQL schema list file template"
		echo "# PgSQL schemas to dump. One entry per line, format:
# user:pass:dbname
# Empty USER or PASS are set per default by dumper-pgsql-export-multiple.sh
# DBNAME is required
# To list current databases use postgres UNIX account:
# [postgres@db ~]$ psql -l
::postgres
::template0
::template1" > "$PGSQL_SCHEMA_LIST" && chmod 600 "$PGSQL_SCHEMA_LIST" && chown 0:0 "$PGSQL_SCHEMA_LIST"
	fi

	if [ ! -f "$AMLOGIN_CHECK_CFG" ]; then
		echo "= Generate an AMServer Login Checker config file template"
		echo "### AMServer Login Checker config file generated by COSas postinstall `date`"'
LOGFILE=/var/log/check-amserver-login.log
AGENT_PORTAL="$BASEDIR/agent-web-amlogin.sh"
'"PSDESKTOPURL='/amserver/UI/Login?module=LDAP&org=orgalias&IDToken1=testname&IDToken2=testpass'"'
' > "$AMLOGIN_CHECK_CFG"
		chmod 600 "$AMLOGIN_CHECK_CFG"
	fi

	if [ ! -f "$MAGNOLIA_CHECK_CFG" ]; then
		echo "= Generate a Magnolia Checker config file template"
		echo "### Magnolia Checker config file generated by COSas postinstall `date`"'
LOGFILE=/var/log/check-magnolia.log
AGENT_PORTAL="$BASEDIR/agent-web-portalOra.sh"
PSDESKTOPURL='/magnoliaPublic/Main.html'
SCRIPT_PORTAL="/etc/init.d/magnolia"
SCRIPT_PORTAL_RESTART=restart
WAIT_C=0
WAIT_S=1
TEMPFILE=/tmp/check-magnolia.test.html
export TEMPFILE
' > "$MAGNOLIA_CHECK_CFG"
		chmod 600 "$MAGNOLIA_CHECK_CFG"
	fi

	if [ ! -f "$DUMPER_GENERIC" ]; then
		echo "= Generate an example Generic-Dumper config file template"
		echo "### Generic-Dumper example config file generated by COSas postinstall `date`"'
TARPREFIX="`hostname`.`domainname`_generic"
TESTDIRMNT="/etc"

DUMPFILE_LIST="\
/etc \
/opt/COSas/etc "
' > "$DUMPER_GENERIC"
		chmod 600 "$DUMPER_GENERIC"
	fi

	if [ ! -f "$DUMPER_LDAP_ADS" ]; then
		echo "= Generate an ADS (DSCC LDAP) Dumper config file template"
		echo "### ADS (DSCC LDAP) Dumper config file generated by COSas postinstall `date`"'
DSINSTANCE="ads"
DSINSTDIR="/var/opt/SUNWdsee/dscc6/dcc/$DSINSTANCE"
BASEDIR="/var/opt/backups/ldap/$DSINSTANCE"
ARCHFILE="$BASEDIR"/"`hostname`.`domainname`_dsbackup-$DSINSTANCE-$TS.tar"
case "`basename $0`" in
*ldif*) ARCHFILE="`echo "$ARCHFILE" | sed s/_dsbackup/_dsexport/`" ;;
esac
DUMPDIR="/DUMP/backups/ldap/$DSINSTANCE"
DUMPFILEBASE="`hostname`.`domainname`_dsexport-$DSINSTANCE-$TS"

DSCONF_PARAMS="-p 3998 -e -i"

CHMOD_OWNER_TEMPDIR=noaccess:noaccess

### Save local LDAP trees
LDAPROOT="cn=dscc"
LDAPORGS=""
LDAPSTD=""
' > "$DUMPER_LDAP_ADS"
		chmod 600 "$DUMPER_LDAP_ADS"
	fi

	if [ ! -f "$DUMPER_LDAP_ADS_LDIF" ]; then
		echo "= Link ADS (DSCC LDAP) binary dumper config file template to LDIF dumper"
		ln -s "`basename "$DUMPER_LDAP_ADS"`" "$DUMPER_LDAP_ADS_LDIF"
	fi

	### Correction for a typo fix in prototype of ~COSas-1.9.26
	### which delivered bad symlinks
	for F in "$BASEDIR/bin/"dumper--portal-*.sh; do
		case "$F" in
			*'*'*) ;;
			*) # Something found...
				if [ -L "$F" ] || [ -h "$F" ]; then
					echo "= Removing bogus symlink (bug in older package version): $F"
					rm -f "$F"
				fi ;;
		esac
	done
fi

true
